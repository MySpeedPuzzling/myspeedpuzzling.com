proxy_cache_path /var/cache/nginx/imgproxy
    levels=1:2
    keys_zone=thumbnails:128m
    inactive=30d
    use_temp_path=off;

upstream imgproxy_backend {
    server imgproxy:8080;
    keepalive 32;
}

upstream minio_backend {
    server minio:9000;
    keepalive 16;
}

server {
    listen 80;

    # Disable access log for performance — errors still logged
    access_log off;

    # Thumbnails — cached (via imgproxy)
    location / {
        proxy_pass http://imgproxy_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        proxy_cache thumbnails;
        proxy_cache_valid 200 365d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 10s;

        # Pass Accept header so imgproxy can do format negotiation
        proxy_set_header Accept $http_accept;

        # Include format in cache key so WebP and JPEG are cached separately
        proxy_cache_key "$request_uri$http_accept";

        proxy_buffer_size 16k;
        proxy_buffers 8 256k;
        proxy_busy_buffers_size 512k;

        add_header X-Cache-Status $upstream_cache_status;
    }

    # Originals — pass-through proxy to MinIO, no disk cache
    location /original/ {
        rewrite ^/original/(.*)$ /puzzle/$1 break;
        proxy_pass http://minio_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;

        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 8 256k;
        proxy_busy_buffers_size 512k;
    }
}
