volumes:
    postgres-data:
    redis-data:
    mailpit-data:

services:
    web:
        image: ghcr.io/myspeedpuzzling/web-base-php85:main
        restart: unless-stopped
        tty: true
        volumes:
            - .:/app
            - .docker/on-startup.sh:/docker-entrypoint.d/on-startup.sh
        depends_on:
            - postgres
            - redis
            - minio
            - mercure
        ports:
            - "8080:8080"
        environment:
            FRANKENPHP_WORKER: "1"
            FRANKENPHP_WATCH: "1"
            FRANKENPHP_MAX_WAIT_TIME: "30s"
            FRANKENPHP_WORKER_NUM: "15"
            XDEBUG_CONFIG: "client_host=host.docker.internal"
            XDEBUG_MODE: debug
            PHP_IDE_CONFIG: "serverName=speedpuzzling"

    postgres:
        image: postgres:16.0
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: speedpuzzling
        volumes:
            - postgres-data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 5s
            timeout: 5s
            retries: 10

    js-watch:
        image: ghcr.io/myspeedpuzzling/web-base-php85:main
        volumes:
            - .:/app
        restart: unless-stopped
        entrypoint: [""]
        command: ["bash", "-c", "npm install && npm run watch"]
        tty: true

    redis:
        image: redis:7.2
        restart: unless-stopped
        volumes:
            - redis-data:/data

    mercure:
        image: dunglas/mercure
        restart: unless-stopped
        command: caddy run --config /etc/caddy/dev.Caddyfile
        environment:
            MERCURE_PUBLISHER_JWT_KEY: "dummy-local-secret-key-for-development-only!"
            MERCURE_SUBSCRIBER_JWT_KEY: "dummy-local-secret-key-for-development-only!"
            SERVER_NAME: ":80"
            MERCURE_EXTRA_DIRECTIVES: |
                cors_origins http://localhost:8080
        ports:
            - "8082:80"

    adminer:
        image: adminer:5.4.1
        ports:
            - "8000:8080"
        environment:
            ADMINER_DEFAULT_SERVER: postgres
        depends_on:
            - postgres

    imgproxy:
        image: darthsim/imgproxy:latest
        restart: unless-stopped
        environment:
            IMGPROXY_USE_S3: "true"
            IMGPROXY_S3_REGION: "global"
            IMGPROXY_S3_ENDPOINT: "http://minio:9000"
            AWS_ACCESS_KEY_ID: "speedpuzzling"
            AWS_SECRET_ACCESS_KEY: "speedpuzzling"
            IMGPROXY_PREFERRED_FORMATS: "avif,webp,jpeg"
            IMGPROXY_AUTO_AVIF: "true"
            IMGPROXY_AUTO_WEBP: "true"
            IMGPROXY_BASE_URL: "s3://puzzle/"
            IMGPROXY_PRESETS: "puzzle_small=rs:fit:200:200,puzzle_medium=rs:fit:400:400/el:1,avatar=rs:fit:300:300"
            IMGPROXY_JPEG_QUALITY: "88"
            IMGPROXY_WEBP_QUALITY: "82"
            IMGPROXY_AVIF_QUALITY: "65"
            IMGPROXY_AUTO_ROTATE: "true"
            IMGPROXY_ENFORCE_THUMBNAIL: "true"
            IMGPROXY_STRIP_METADATA: "true"
            IMGPROXY_STRIP_COLOR_PROFILE: "true"
            IMGPROXY_AVIF_SPEED: "7"
            IMGPROXY_MAX_SRC_RESOLUTION: "50"
        depends_on:
            - minio

    images-cache:
        image: nginx:alpine
        restart: unless-stopped
        volumes:
            - .docker/nginx-imgproxy.conf:/etc/nginx/conf.d/default.conf
            - .docker-data/imgproxy-cache:/var/cache/nginx/imgproxy
        depends_on:
            - imgproxy
        ports:
            - "19100:80"

    minio:
        restart: always
        image: minio/minio:latest
        environment:
            MINIO_DOMAIN: "localhost:19000"
            MINIO_SERVER_URL: "http://minio:9000"
            MINIO_BROWSER_REDIRECT_URL: "http://localhost:19001"
            MINIO_ROOT_USER: speedpuzzling
            MINIO_ROOT_PASSWORD: speedpuzzling
        command: ["server", "/data", "--console-address", ":9001"]
        ports:
            - 19000:9000
            - 19001:9001
        volumes:
            - .docker-data/minio-data:/data

    mailer:
        image: axllent/mailpit
        ports:
            - "1025:1025"
            - "8025:8025"
        environment:
            MP_SMTP_AUTH_ACCEPT_ANY: 1
            MP_SMTP_AUTH_ALLOW_INSECURE: 1
            MP_DATABASE: "/data/mailpit.db"
        volumes:
            - mailpit-data:/data

    chrome:
        image: ${SELENIUM_IMAGE:-seleniarm/standalone-chromium:latest}
        shm_size: 2gb
        ports:
            - "4444:4444"
            - "7900:7900"
        environment:
            - SE_NODE_MAX_SESSIONS=4

    web-test:
        image: ghcr.io/myspeedpuzzling/web-base-php85:main
        restart: unless-stopped
        tty: true
        volumes:
            - .:/app
            - .docker/on-startup.sh:/docker-entrypoint.d/on-startup.sh
        depends_on:
            - web
            - chrome
        ports:
            - "8081:8080"
        environment:
            APP_ENV: test
            # Skip migrations - test database is set up by PHPUnit bootstrap.php
            SKIP_DATABASE_MIGRATIONS: "true"

    listmonk-init:
        image: postgres:16.0
        environment:
            PGPASSWORD: postgres
        command: >
            sh -c "psql -h postgres -U postgres -tc \"SELECT 1 FROM pg_database WHERE datname = 'listmonk'\" | grep -q 1 || psql -h postgres -U postgres -c \"CREATE DATABASE listmonk\""
        depends_on:
            postgres:
                condition: service_healthy

    listmonk:
        image: listmonk/listmonk:latest
        restart: unless-stopped
        ports:
            - "9000:9000"
        environment:
            TZ: Europe/Prague
            LISTMONK_app__address: 0.0.0.0:9000
            LISTMONK_app__admin_username: admin
            LISTMONK_app__admin_password: admin
            LISTMONK_db__host: postgres
            LISTMONK_db__port: 5432
            LISTMONK_db__user: postgres
            LISTMONK_db__password: postgres
            LISTMONK_db__database: listmonk
            LISTMONK_db__ssl_mode: disable
            LISTMONK_db__max_open: 25
            LISTMONK_db__max_idle: 25
            LISTMONK_db__max_lifetime: 300s
            LISTMONK_smtp__enabled: true
            LISTMONK_smtp__host: mailer
            LISTMONK_smtp__port: 1025
            LISTMONK_smtp__auth_protocol: none
            LISTMONK_smtp__tls_type: none
            LISTMONK_smtp__max_conns: 10
            LISTMONK_smtp__idle_timeout: 15s
            LISTMONK_smtp__wait_timeout: 5s
            LISTMONK_smtp__max_msg_retries: 2
        command: >
            sh -c "./listmonk --install --idempotent --yes --config '' &&
                   ./listmonk --upgrade --yes --config '' &&
                   ./listmonk --config ''"
        depends_on:
            listmonk-init:
                condition: service_completed_successfully
            mailer:
                condition: service_started
