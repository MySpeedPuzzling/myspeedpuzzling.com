<div data-controller="add-copuzzler image-editor"
     data-image-editor-title-value="{{ 'image_editor.title'|trans }}"
     data-image-editor-rotate-left-value="{{ 'image_editor.rotate_left'|trans }}"
     data-image-editor-rotate-right-value="{{ 'image_editor.rotate_right'|trans }}"
     data-image-editor-cancel-value="{{ 'forms.cancel'|trans }}"
     data-image-editor-apply-value="{{ 'image_editor.apply'|trans }}"
     data-image-editor-edit-value="{{ 'forms.edit'|trans }}">

    {{ form_start(solving_time_form, { 'attr': {
        'data-controller': 'submit-prevention ppm-validator',
        'data-ppm-validator-active-puzzle-pieces-value': active_puzzle is defined and active_puzzle is not null ? active_puzzle.piecesCount : 0,
        'data-ppm-validator-warning-too-fast-value': 'forms.ppm_warning_too_fast'|trans,
        'data-ppm-validator-warning-too-slow-value': 'forms.ppm_warning_too_slow'|trans,
        'data-ppm-validator-label-hours-value': 'forms.hours'|trans,
        'data-ppm-validator-label-minutes-value': 'forms.minutes'|trans,
        'data-ppm-validator-label-seconds-value': 'forms.seconds'|trans,
    } }) }}
        {{ form_errors(solving_time_form) }}

        {# Hidden mode field - controlled by Stimulus (only for add form) #}
        {% if solving_time_form.mode is defined %}
            {{ form_widget(solving_time_form.mode, {'attr': {'data-puzzle-add-form-target': 'modeInput', 'data-ppm-validator-target': 'modeInput', 'class': 'd-none'}}) }}
        {% endif %}

        <div class="row pb-4"
             {% if active_puzzle is null %}
             data-controller="time-form-autocomplete"
             data-time-form-autocomplete-ean-search-url-value="{{ path('puzzle_by_ean_search', {ean: '__EAN__'}) }}"
             data-time-form-autocomplete-not-found-message-value="{{ 'scan.puzzle_form.not_found'|trans }}"
             data-time-form-autocomplete-multiple-brands-message-value="{{ 'scan.puzzle_form.multiple_brands'|trans }}"
             data-time-form-autocomplete-multiple-puzzles-message-value="{{ 'scan.puzzle_form.multiple_puzzles'|trans }}"
             {% endif %}>
            <div class="col-lg-6 order-lg-1">

                {% if active_puzzle is not null %}
                    <div class="card card-body shadow mb-3">
                        <h5>{{ 'puzzle_add.chosen_puzzle'|trans }}</h5>

                        <div class="py-1 d-flex low-line-height">
                            {% if active_puzzle.puzzleImage is not null%}
                                <div class="icon me-2">
                                    <img class="rounded-2" style="max-width: 100px;max-height: 100px;"  alt="{{ 'puzzle_img_alt'|trans({'%puzzle%': active_puzzle.manufacturerName ~ ' ' ~ active_puzzle.puzzleName}) }}" src="{{ active_puzzle.puzzleImage|imagine_filter('puzzle_medium') }}">
                                </div>
                            {% endif %}

                            <div class="pe-1">
                                <div class="mb-1">
                                    <span class="h6">{{ active_puzzle.puzzleName }}</span>
                                    <small class="text-muted">{{ active_puzzle.puzzleIdentificationNumber }}</small><br>
                                    {{ active_puzzle.manufacturerName|upper }}<br>
                                </div>
                                <div class="description"><small>{{ 'pieces_count'|trans({ '%count%': active_puzzle.piecesCount })|raw }}</small></div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div {% if active_puzzle is not null %}style="display: none;"{% endif %}>
                    <div class="card card-body shadow mb-3">
                        <div data-time-form-autocomplete-target="scannerMessage" class="alert alert-warning d-none small mb-3"></div>

                        {{ form_row(solving_time_form.brand, {'attr': {'data-time-form-autocomplete-target': 'brand'}}) }}

                        {{ form_label(solving_time_form.puzzle) }}
                        <div class="input-group mb-3">
                            {{ form_widget(solving_time_form.puzzle, {'attr': {'data-time-form-autocomplete-target': 'puzzle'}}) }}
                            {% if active_puzzle is null %}
                                <button type="button" class="btn btn-outline-secondary"
                                        data-action="click->time-form-autocomplete#openScanner"
                                        title="{{ 'scan.title'|trans }}">
                                    <i class="bi-upc-scan"></i>
                                </button>
                            {% endif %}
                        </div>
                        {{ form_errors(solving_time_form.puzzle) }}

                        <div data-time-form-autocomplete-target="newPuzzle" class="{{ hide_new_puzzle|default(false) ? 'd-none' }}">
                            <p>
                                <small class="text-muted">{{ 'puzzle_add.need_approve_info'|trans }}</small>
                            </p>

                            {{ form_row(solving_time_form.puzzlePiecesCount, {'attr': {'data-ppm-validator-target': 'puzzlePiecesCount'}}) }}

                            {{ form_label(solving_time_form.puzzleEan) }}
                            <div class="input-group mb-3">
                                {{ form_widget(solving_time_form.puzzleEan, {'attr': {'data-time-form-autocomplete-target': 'eanInput'}}) }}
                                {% if active_puzzle is null %}
                                    <button type="button" class="btn btn-outline-secondary"
                                            data-action="click->time-form-autocomplete#openScanner"
                                            title="{{ 'scan.title'|trans }}">
                                        <i class="bi-upc-scan"></i>
                                    </button>
                                {% endif %}
                            </div>
                            {{ form_errors(solving_time_form.puzzleEan) }}
                            {{ form_row(solving_time_form.puzzleIdentificationNumber) }}

                            {{ form_label(solving_time_form.puzzlePhoto) }}
                            {{ form_errors(solving_time_form.puzzlePhoto) }}

                            <div class="form-text mb-1 help-text">{{ 'forms.puzzle_photo_help'|trans }}</div>
                            <div class="file-drop-area">
                                <div class="file-drop-icon ci-cloud-upload"></div>
                                <span class="file-drop-message">{{ 'forms.drop_file'|trans }}</span>
                                {{ form_widget(solving_time_form.puzzlePhoto, {'attr': {'class': 'file-drop-input'}}) }}
                                <button type="button" class="file-drop-btn btn btn-outline-primary btn-sm">{{ 'forms.choose_file'|trans }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 order-lg-2">
                {# Time and date section (Speed + Relax, but time only for Speed) #}
                <div class="card card-body shadow mb-3" data-puzzle-add-form-target="timeAndDateSection">
                    <div class="row">
                        {# Time field - Speed Puzzling only #}
                        <div class="col-sm mb-3" data-puzzle-add-form-target="timeSection">
                            {% if active_stopwatch is not null %}
                                <span class="form-label">{{ 'puzzle_add.time_from_stopwatch'|trans }}</span><br>
                                <span class="h5 mt-2 d-inline-block">{{ active_stopwatch.totalSeconds|puzzlingTime }}</span>
                            {% endif %}

                            <div style="{% if active_stopwatch is not null %}display: none;{% endif %}">
                                <label class="form-label required">{{ 'time'|trans }}</label>
                                <div class="d-flex align-items-center gap-1">
                                    <div class="flex-grow-1">
                                        {{ form_widget(solving_time_form.timeHours, {'attr': {'data-ppm-validator-target': 'timeHours'}}) }}
                                        <div class="text-center text-muted small">{{ 'forms.hours_short'|trans }}</div>
                                    </div>
                                    <span class="fs-4 text-muted pb-3">:</span>
                                    <div class="flex-grow-1">
                                        {{ form_widget(solving_time_form.timeMinutes, {'attr': {'data-ppm-validator-target': 'timeMinutes'}}) }}
                                        <div class="text-center text-muted small">{{ 'forms.minutes_short'|trans }}</div>
                                    </div>
                                    <span class="fs-4 text-muted pb-3">:</span>
                                    <div class="flex-grow-1">
                                        {{ form_widget(solving_time_form.timeSeconds, {'attr': {'data-ppm-validator-target': 'timeSeconds'}}) }}
                                        <div class="text-center text-muted small">{{ 'forms.seconds_short'|trans }}</div>
                                    </div>
                                </div>
                                {{ form_errors(solving_time_form.timeHours) }}
                                {{ form_errors(solving_time_form.timeMinutes) }}
                                {{ form_errors(solving_time_form.timeSeconds) }}
                            </div>
                        </div>

                        {# Date field - Speed + Relax #}
                        <div class="col-sm mb-3">
                            {{ form_label(solving_time_form.finishedAt) }}
                            <div class="input-group">
                                {{ form_widget(solving_time_form.finishedAt, {'attr': {'class': 'form-control rounded date-picker pe-5', 'data-datepicker-options': '{"altInput": true, "altFormat": "d.m.Y", "dateFormat": "d.m.Y", "maxDate": "today"}'}}) }}
                                <i class="ci-calendar position-absolute top-50 end-0 translate-middle-y me-3"></i>
                            </div>
                            {{ form_help(solving_time_form.finishedAt) }}
                            {{ form_errors(solving_time_form.finishedAt) }}
                        </div>
                    </div>

                    {# First attempt - Speed Puzzling only #}
                    <div class="form-switch" data-puzzle-add-form-target="firstAttemptSection">
                        {{ form_row(solving_time_form.firstAttempt) }}
                    </div>
                </div>

                {# Group players section (Speed + Relax only) #}
                <div data-puzzle-add-form-target="groupSection">
                    {% set has_group_players = filled_group_players is defined and filled_group_players|length > 0 %}
                    <div data-controller="toggle">
                        <button type="button" class="btn btn-outline-primary w-100 mb-3 shadow {{ has_group_players ? 'hidden' }}" data-action="click->toggle#toggle click->add-copuzzler#addPuzzler" data-toggle-target-param="group">
                            <i class="ci-add-user me-1"></i> {{ 'puzzle_add.group_puzzling'|trans }}
                        </button>

                        <div class="card card-body shadow mb-3 {{ not has_group_players ? 'hidden' }}" data-toggle-target="group">
                            <div data-add-copuzzler-target="puzzlersGroup" data-ppm-validator-target="groupPlayers">
                                {% for filled_group_player in filled_group_players %}
                                    {{ include('_group_puzzler_input.html.twig', {
                                        inputId: loop.index,
                                        inputValue: filled_group_player,
                                    }) }}
                                {% endfor %}
                            </div>

                            <button id="add-puzzler" data-action="click->add-copuzzler#addPuzzler" data-add-copuzzler-target="addPuzzlerBtn" type="button" class="btn btn-sm btn-outline-primary"><i class="ci-add-user"></i> {{ 'puzzle_add.add_puzzler'|trans }}</button>
                        </div>
                    </div>
                </div>

                {# Competition section (Speed Puzzling only) #}
                <div data-puzzle-add-form-target="competitionSection">
                    {% set competition_filled = solving_time_form.competition.vars.value is not empty %}
                    <div data-controller="toggle">
                        <button type="button" class="btn btn-outline-accent shadow w-100 mb-3 {{ competition_filled ? 'hidden' }}" data-action="click->toggle#toggle" data-toggle-target-param="competition">
                            <i class="bi-trophy me-1"></i> {{ 'puzzle_add.competition_result'|trans }}
                        </button>

                        <div class="card card-body shadow mb-3 {{ not competition_filled ? 'hidden' }}" data-toggle-target="competition">
                            {{ form_label(solving_time_form.competition) }}
                            {{ form_widget(solving_time_form.competition, {'attr': {'data-time-form-autocomplete-target': 'competition'}}) }}
                            {{ form_help(solving_time_form.competition) }}
                            {{ form_errors(solving_time_form.competition) }}
                        </div>
                    </div>
                </div>

                {# Comment and photo section (Speed + Relax only) #}
                <div class="card card-body shadow mb-3" data-puzzle-add-form-target="commonSection">
                    {{ form_row(solving_time_form.comment) }}

                    {{ form_label(solving_time_form.finishedPuzzlesPhoto) }}
                    {{ form_errors(solving_time_form.finishedPuzzlesPhoto) }}

                    <div class="file-drop-area">
                        <div class="file-drop-icon">
                            {% if solved_puzzle is defined and solved_puzzle.finishedPuzzlePhoto is not null%}
                                <div class="file-drop-preview img-thumbnail rounded">
                                    <img class="rounded-2" style="max-width: 200px;max-height: 200px;" alt="{{ 'puzzle_img_alt'|trans({'%puzzle%': solved_puzzle.manufacturerName ~ ' ' ~ solved_puzzle.puzzleName}) }}" src="{{ solved_puzzle.finishedPuzzlePhoto|imagine_filter('puzzle_medium') }}">
                                </div>
                            {% endif %}
                            <i class="ci-cloud-upload"></i>
                        </div>

                        <span class="file-drop-message">{{ 'forms.drop_file'|trans }}</span>
                        {{ form_widget(solving_time_form.finishedPuzzlesPhoto, {'attr': {'class': 'file-drop-input'}}) }}
                        <button type="button" class="file-drop-btn btn btn-outline-primary btn-sm">{{ 'forms.choose_file'|trans }}</button>
                    </div>
                </div>

                {# Collection section (Collection mode only, not in edit form) #}
                {% if solving_time_form.collection is defined %}
                    <div class="card card-body shadow mb-3 d-none" data-puzzle-add-form-target="collectionSection">
                        {% if not has_active_membership|default(true) %}
                            {# Non-member: show locked input with system collection name #}
                            <div class="mb-3">
                                <label class="form-label">{{ 'forms.add_puzzle_to_collection.collection'|trans }}</label>
                                <div class="input-group">
                                    <input type="text" class="form-control"
                                           value="{{ 'collections.system_name'|trans }}" disabled readonly>
                                    <span class="input-group-text bg-light">
                                        <i class="ci-locked"></i>
                                    </span>
                                </div>
                                <small class="form-text text-muted">
                                    {{ 'collections.membership_required.help_text'|trans }}
                                    <button type="button" class="btn btn-link btn-sm p-0 align-baseline"
                                            data-bs-toggle="modal" data-bs-target="#membersExclusiveModal">
                                        <i class="ci-locked"></i> {{ 'collections.membership_required.unlock_link'|trans }}
                                    </button>
                                </small>
                            </div>
                            {# Hidden actual collection field with system collection pre-selected #}
                            {{ form_row(solving_time_form.collection, {'row_attr': {'class': 'd-none'}}) }}
                        {% else %}
                            {# Member: show collection selector with autocomplete #}
                            {{ form_row(solving_time_form.collection) }}

                            <div data-puzzle-add-form-target="newCollectionFields" class="d-none">
                                <div class="border rounded p-3 bg-light mb-3">
                                    <h6 class="mb-3">{{ 'collections.create.title'|trans }}</h6>
                                    {{ form_row(solving_time_form.collectionVisibility) }}
                                    {{ form_row(solving_time_form.collectionDescription) }}
                                </div>
                            </div>
                        {% endif %}

                        {{ form_row(solving_time_form.collectionComment) }}
                    </div>
                {% endif %}
            </div>

            {# Barcode Scanner Modal - must be inside the time-form-autocomplete controller scope #}
            {% if active_puzzle is null %}
                <div class="modal fade"
                     tabindex="-1"
                     role="dialog"
                     data-time-form-autocomplete-target="scannerModal"
                     data-controller="barcode-scanner"
                     id="barcodeScannerModal">
                    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">{{ 'scan.title'|trans }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div data-barcode-scanner-target="wrapper" class="modal-barcode-scan position-relative">
                                    <div class="spinner spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <video class="w-100 d-block" data-barcode-scanner-target="video" muted autoplay playsinline></video>
                                    <canvas data-barcode-scanner-target="overlay" class="position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none;"></canvas>

                                    <div data-barcode-scanner-target="zoomContainer" class="d-none position-absolute bottom-0 start-50 translate-middle-x mb-3 bg-white rounded-pill px-3 py-2 shadow-sm">
                                        <span data-barcode-scanner-target="zoomValue" class="me-2 small">Zoom 1x</span>
                                        <button type="button"
                                                data-action="click->barcode-scanner#zoomOut"
                                                data-barcode-scanner-target="zoomOut"
                                                class="btn btn-sm btn-outline-secondary rounded-circle p-1 me-1">
                                            <i class="bi-dash"></i>
                                        </button>
                                        <button type="button"
                                                data-action="click->barcode-scanner#zoomIn"
                                                data-barcode-scanner-target="zoomIn"
                                                class="btn btn-sm btn-outline-secondary rounded-circle p-1">
                                            <i class="bi-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <p class="text-muted small px-3 py-2 mb-0">{{ 'scan.instructions'|trans }}</p>
                            </div>
                            <div class="modal-footer justify-content-center d-none">
                                <button type="button"
                                        class="btn btn-outline-secondary d-none"
                                        data-barcode-scanner-target="toggleButton"
                                        data-action="click->barcode-scanner#toggle">
                                    {{ 'scan.title'|trans }}
                                </button>
                            </div>
                            {# Hidden input for barcode scanner controller #}
                            <input type="hidden" data-barcode-scanner-target="input">
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <button type="submit" name="submit" class="btn btn-primary w-100" data-submit-prevention-target="submit">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <i class="ci-check me-1"></i> {{ 'forms.save'|trans }}
        </button>

        {# PPM Warning Modal #}
        <div class="modal fade" tabindex="-1" role="dialog" data-ppm-validator-target="modal">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-2 flex-column align-items-center text-center">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
                        <div class="text-warning mb-2">
                            <i class="ci-time" style="font-size: 2.5rem;"></i>
                        </div>
                        <h5 class="modal-title mb-1">{{ 'forms.ppm_warning_title'|trans }}</h5>
                        <small class="text-muted">{{ 'forms.ppm_entered_time'|trans }}:</small>
                    </div>
                    <div class="modal-body pt-2">
                        <div class="text-center mb-4" data-ppm-validator-target="timeDisplay"></div>
                        <p class="text-muted text-center mb-0" data-ppm-validator-target="warningMessage"></p>
                    </div>
                    <div class="modal-footer border-0 pt-0 justify-content-center">
                        <button type="button" class="btn btn-outline-secondary" data-action="click->ppm-validator#cancelSubmit" data-bs-dismiss="modal">
                            <i class="ci-edit me-1"></i>
                            {{ 'forms.ppm_cancel_button'|trans }}
                        </button>
                        <button type="button" class="btn btn-primary" data-action="click->ppm-validator#confirmSubmit">
                            <i class="ci-check me-1"></i>
                            {{ 'forms.ppm_confirm_button'|trans }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {{ form_end(solving_time_form) }}

    <div id="puzzler-input-template" data-add-copuzzler-target="puzzlerTemplate">
        {{ include('_group_puzzler_input.html.twig') }}
    </div>
</div>
