<div {{ attributes }}>
    {# Loading spinner #}
    <div class="text-primary text-center my-3" style="display: none;" data-loading="show">
        <span class="spinner-border spinner-border-sm" role="status"></span>
    </div>

    {# Filters #}
    <div class="card shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="d-lg-none mb-2">
                <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#marketplaceFilters" aria-expanded="false">
                    <i class="bi-filter me-1"></i> {{ 'marketplace.filter.filters'|trans }}
                </button>
            </div>

            <div class="collapse d-lg-block" id="marketplaceFilters">
                <div class="row g-2 align-items-end">
                    {# Search #}
                    <div class="col-12 col-md-6 col-lg-3">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.search_placeholder'|trans }}</small></label>
                        <input
                            type="text"
                            data-model="debounce(300)|search"
                            class="form-control form-control-sm"
                            value="{{ this.search }}"
                            placeholder="{{ 'marketplace.search_placeholder'|trans }}"
                        >
                    </div>

                    {# Manufacturer #}
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.brand'|trans }}</small></label>
                        <select data-model="manufacturer" class="form-select form-select-sm">
                            <option value="">{{ 'marketplace.all_brands'|trans }}</option>
                            {% for mfr in this.manufacturers %}
                                <option value="{{ mfr.manufacturer_id }}" {{ this.manufacturer == mfr.manufacturer_id ? 'selected' }}>
                                    {{ mfr.manufacturer_name }} ({{ mfr.listing_count }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Pieces range #}
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.pieces'|trans }}</small></label>
                        <div class="d-flex gap-1">
                            <input
                                type="number"
                                data-model="debounce(300)|piecesMin"
                                class="form-control form-control-sm"
                                value="{{ this.piecesMin }}"
                                placeholder="{{ 'marketplace.min'|trans }}"
                                min="0"
                            >
                            <input
                                type="number"
                                data-model="debounce(300)|piecesMax"
                                class="form-control form-control-sm"
                                value="{{ this.piecesMax }}"
                                placeholder="{{ 'marketplace.max'|trans }}"
                                min="0"
                            >
                        </div>
                    </div>

                    {# Listing type #}
                    <div class="col-6 col-md-3 col-lg-1">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.type'|trans }}</small></label>
                        <select data-model="listingType" class="form-select form-select-sm">
                            <option value="">{{ 'marketplace.all'|trans }}</option>
                            <option value="sell" {{ this.listingType == 'sell' ? 'selected' }}>{{ 'marketplace.listing_type.sell'|trans }}</option>
                            <option value="swap" {{ this.listingType == 'swap' ? 'selected' }}>{{ 'marketplace.listing_type.swap'|trans }}</option>
                            <option value="both" {{ this.listingType == 'both' ? 'selected' }}>{{ 'marketplace.listing_type.both'|trans }}</option>
                            <option value="free" {{ this.listingType == 'free' ? 'selected' }}>{{ 'marketplace.listing_type.free'|trans }}</option>
                        </select>
                    </div>

                    {# Price range #}
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.price'|trans }}</small></label>
                        <div class="d-flex gap-1">
                            <input
                                type="number"
                                data-model="debounce(300)|priceMin"
                                class="form-control form-control-sm"
                                value="{{ this.priceMin }}"
                                placeholder="{{ 'marketplace.min'|trans }}"
                                min="0"
                                step="0.01"
                            >
                            <input
                                type="number"
                                data-model="debounce(300)|priceMax"
                                class="form-control form-control-sm"
                                value="{{ this.priceMax }}"
                                placeholder="{{ 'marketplace.max'|trans }}"
                                min="0"
                                step="0.01"
                            >
                        </div>
                    </div>

                    {# Condition #}
                    <div class="col-6 col-md-3 col-lg-1">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.condition'|trans }}</small></label>
                        <select data-model="condition" class="form-select form-select-sm">
                            <option value="">{{ 'marketplace.all'|trans }}</option>
                            <option value="like_new" {{ this.condition == 'like_new' ? 'selected' }}>{{ 'marketplace.condition.like_new'|trans }}</option>
                            <option value="normal" {{ this.condition == 'normal' ? 'selected' }}>{{ 'marketplace.condition.normal'|trans }}</option>
                            <option value="not_so_good" {{ this.condition == 'not_so_good' ? 'selected' }}>{{ 'marketplace.condition.not_so_good'|trans }}</option>
                            <option value="missing_pieces" {{ this.condition == 'missing_pieces' ? 'selected' }}>{{ 'marketplace.condition.missing_pieces'|trans }}</option>
                        </select>
                    </div>

                    {# Ships to #}
                    {% set defaultShipsTo = this.defaultShipsTo %}
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.ships_to'|trans }}</small></label>
                        <select data-model="shipsTo" class="form-select form-select-sm">
                            <option value="">{{ 'marketplace.all_countries'|trans }}</option>
                            {% for country in enum('SpeedPuzzling\\Web\\Value\\CountryCode').cases %}
                                <option value="{{ country.name }}" {{ defaultShipsTo == country.name ? 'selected' }}>
                                    {{ country.value }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Sort #}
                    <div class="col-6 col-md-3 col-lg-1">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.sort'|trans }}</small></label>
                        <select data-model="sort" class="form-select form-select-sm">
                            <option value="newest" {{ this.sort == 'newest' ? 'selected' }}>{{ 'marketplace.sort.newest'|trans }}</option>
                            <option value="price_asc" {{ this.sort == 'price_asc' ? 'selected' }}>{{ 'marketplace.sort.price_asc'|trans }}</option>
                            <option value="price_desc" {{ this.sort == 'price_desc' ? 'selected' }}>{{ 'marketplace.sort.price_desc'|trans }}</option>
                            {% if this.search is not empty %}
                                <option value="relevance" {{ this.sort == 'relevance' ? 'selected' }}>{{ 'marketplace.sort.relevance'|trans }}</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                {% if logged_user.profile is not null %}
                    <div class="mt-2">
                        <div class="form-check">
                            <input type="checkbox" data-model="myOffers" class="form-check-input" id="myOffersFilter" {{ this.myOffers ? 'checked' }}>
                            <label class="form-check-label" for="myOffersFilter"><small>{{ 'marketplace.my_offers'|trans }}</small></label>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# Results count #}
    {% set resultCount = this.resultCount %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted">{{ resultCount == 1 ? 'marketplace.result'|trans : 'marketplace.results'|trans({'%count%': resultCount}) }}</small>
    </div>

    {# Results grid #}
    {% set items = this.items %}
    {% if items is empty %}
        <div class="text-center py-5">
            <i class="bi bi-shop fs-1 text-muted"></i>
            <p class="text-muted mt-2">{{ 'marketplace.no_results'|trans }}</p>
        </div>
    {% else %}
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
            {% for item in items %}
                <div class="col">
                    {% include 'marketplace/_listing_card.html.twig' with {item: item} only %}
                </div>
            {% endfor %}
        </div>

        {# Pagination #}
        {% set totalPages = this.totalPages %}
        {% if totalPages > 1 %}
            <nav class="mt-4" aria-label="Marketplace pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if this.page > 1 %}
                        <li class="page-item">
                            <button class="page-link" data-model="page" data-value="{{ this.page - 1 }}" data-action="live#update">&laquo;</button>
                        </li>
                    {% endif %}

                    {% for p in 1..totalPages %}
                        {% if p == this.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ p }}</span>
                            </li>
                        {% elseif p <= 3 or p > totalPages - 3 or (p >= this.page - 1 and p <= this.page + 1) %}
                            <li class="page-item">
                                <button class="page-link" data-model="page" data-value="{{ p }}" data-action="live#update">{{ p }}</button>
                            </li>
                        {% elseif p == 4 or p == totalPages - 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">&hellip;</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if this.page < totalPages %}
                        <li class="page-item">
                            <button class="page-link" data-model="page" data-value="{{ this.page + 1 }}" data-action="live#update">&raquo;</button>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    {% endif %}
</div>
