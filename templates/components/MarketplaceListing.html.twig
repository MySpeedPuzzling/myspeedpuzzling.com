<div {{ attributes }}>
    {# Filters #}
    <div class="card shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="d-md-none">
                <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#marketplaceFilters" aria-expanded="false">
                    <i class="bi-filter me-1"></i> {{ 'marketplace.filter.filters'|trans }}
                </button>
            </div>

            <div class="collapse mt-2 mt-md-0 d-md-block" id="marketplaceFilters">
                <div class="row g-2 align-items-end">
                    {# Search #}
                    <div class="col-12 col-md-6 col-lg-3">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.search_placeholder'|trans }}</small></label>
                        <input
                            type="text"
                            data-model="debounce(300)|search"
                            class="form-control form-control-sm"
                            value="{{ this.search }}"
                            placeholder="{{ 'marketplace.search_placeholder'|trans }}"
                        >
                    </div>

                    {# Manufacturer #}
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.brand'|trans }}</small></label>
                        <select data-model="manufacturer" class="form-select form-select-sm">
                            <option value="">{{ 'marketplace.all_brands'|trans }}</option>
                            {% for mfr in this.manufacturers %}
                                <option value="{{ mfr.manufacturer_id }}" {{ this.manufacturer == mfr.manufacturer_id ? 'selected' }}>
                                    {{ mfr.manufacturer_name }} ({{ mfr.listing_count }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Pieces range #}
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.pieces'|trans }}</small></label>
                        <div class="d-flex gap-1">
                            <input
                                type="number"
                                data-model="debounce(300)|piecesMin"
                                class="form-control form-control-sm"
                                value="{{ this.piecesMin }}"
                                placeholder="{{ 'marketplace.min'|trans }}"
                                min="0"
                            >
                            <input
                                type="number"
                                data-model="debounce(300)|piecesMax"
                                class="form-control form-control-sm"
                                value="{{ this.piecesMax }}"
                                placeholder="{{ 'marketplace.max'|trans }}"
                                min="0"
                            >
                        </div>
                    </div>

                    {# Listing type #}
                    <div class="col-6 col-md-3 col-lg-1">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.type'|trans }}</small></label>
                        <select data-model="listingType" class="form-select form-select-sm">
                            <option value="">{{ 'marketplace.all'|trans }}</option>
                            <option value="sell" {{ this.listingType == 'sell' ? 'selected' }}>{{ 'marketplace.listing_type.sell'|trans }}</option>
                            <option value="swap" {{ this.listingType == 'swap' ? 'selected' }}>{{ 'marketplace.listing_type.swap'|trans }}</option>
                            <option value="both" {{ this.listingType == 'both' ? 'selected' }}>{{ 'marketplace.listing_type.both'|trans }}</option>
                            <option value="free" {{ this.listingType == 'free' ? 'selected' }}>{{ 'marketplace.listing_type.free'|trans }}</option>
                        </select>
                    </div>

                    {# Price range #}
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.price'|trans }}</small></label>
                        <div class="d-flex gap-1">
                            <input
                                type="number"
                                data-model="debounce(300)|priceMin"
                                class="form-control form-control-sm"
                                value="{{ this.priceMin }}"
                                placeholder="{{ 'marketplace.min'|trans }}"
                                min="0"
                                step="0.01"
                            >
                            <input
                                type="number"
                                data-model="debounce(300)|priceMax"
                                class="form-control form-control-sm"
                                value="{{ this.priceMax }}"
                                placeholder="{{ 'marketplace.max'|trans }}"
                                min="0"
                                step="0.01"
                            >
                        </div>
                    </div>

                    {# Condition #}
                    <div class="col-6 col-md-3 col-lg-1">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.condition'|trans }}</small></label>
                        <select data-model="condition" class="form-select form-select-sm">
                            <option value="">{{ 'marketplace.all'|trans }}</option>
                            <option value="like_new" {{ this.condition == 'like_new' ? 'selected' }}>{{ 'marketplace.condition.like_new'|trans }}</option>
                            <option value="normal" {{ this.condition == 'normal' ? 'selected' }}>{{ 'marketplace.condition.normal'|trans }}</option>
                            <option value="not_so_good" {{ this.condition == 'not_so_good' ? 'selected' }}>{{ 'marketplace.condition.not_so_good'|trans }}</option>
                            <option value="missing_pieces" {{ this.condition == 'missing_pieces' ? 'selected' }}>{{ 'marketplace.condition.missing_pieces'|trans }}</option>
                        </select>
                    </div>

                    {# Sort #}
                    <div class="col-6 col-md-3 col-lg-1">
                        <label class="form-label form-label-sm mb-0"><small>{{ 'marketplace.filter.sort'|trans }}</small></label>
                        <select data-model="sort" class="form-select form-select-sm">
                            <option value="newest" {{ this.sort == 'newest' ? 'selected' }}>{{ 'marketplace.sort.newest'|trans }}</option>
                            <option value="price_asc" {{ this.sort == 'price_asc' ? 'selected' }}>{{ 'marketplace.sort.price_asc'|trans }}</option>
                            <option value="price_desc" {{ this.sort == 'price_desc' ? 'selected' }}>{{ 'marketplace.sort.price_desc'|trans }}</option>
                            {% if this.search is not empty %}
                                <option value="relevance" {{ this.sort == 'relevance' ? 'selected' }}>{{ 'marketplace.sort.relevance'|trans }}</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div class="mt-2 d-flex flex-wrap gap-3">
                    {# Ship to my country #}
                    {% set userCountry = this.userCountry %}
                    <div class="form-check">
                        <input
                            type="checkbox"
                            data-model="shipToMyCountry"
                            class="form-check-input"
                            id="shipToMyCountryFilter"
                            {{ this.shipToMyCountry ? 'checked' }}
                            {{ userCountry is null ? 'disabled' }}
                        >
                        <label class="form-check-label" for="shipToMyCountryFilter">
                            <small>
                                {% if userCountry is not null %}
                                    {{ 'marketplace.filter.ship_to_my_country'|trans }}
                                {% else %}
                                    {{ 'marketplace.filter.ship_to_my_country_disabled'|trans }}
                                    <a href="{{ path('edit_profile') }}">{{ 'marketplace.filter.set_country_link'|trans }}</a>
                                {% endif %}
                            </small>
                        </label>
                    </div>

                    {# My offers #}
                    {% if logged_user.profile is not null %}
                        <div class="form-check">
                            <input type="checkbox" data-model="myOffers" class="form-check-input" id="myOffersFilter" {{ this.myOffers ? 'checked' }}>
                            <label class="form-check-label" for="myOffersFilter"><small>{{ 'marketplace.my_offers'|trans }}</small></label>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Puzzle filter indicator #}
    {% if this.puzzleId is not empty %}
        {% set puzzleName = this.puzzleName %}
        {% if puzzleName is not null %}
            <div class="alert alert-info d-flex justify-content-between align-items-center mb-3 py-2">
                <span>{{ 'marketplace.showing_offers_for'|trans }} <strong>{{ puzzleName }}</strong></span>
                <a href="{{ path('marketplace') }}" class="btn btn-sm btn-outline-info">{{ 'marketplace.show_all'|trans }}</a>
            </div>
        {% endif %}
    {% endif %}

    {# Results count #}
    {% set resultCount = this.resultCount %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted">
            {{ resultCount == 1 ? 'marketplace.result'|trans : 'marketplace.results'|trans({'%count%': resultCount}) }}
            <span class="spinner-border spinner-border-sm ms-2 text-primary invisible" role="status" data-loading="removeClass(invisible)"></span>
        </small>
    </div>

    {# Results grid #}
    {% set items = this.items %}
    {% if items is empty %}
        <div class="text-center py-5">
            <i class="bi bi-shop fs-1 text-muted"></i>
            <p class="text-muted mt-2">{{ 'marketplace.no_results'|trans }}</p>
        </div>
    {% else %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            {% set marketplaceReturnUrl = this.returnUrl %}
            {% for item in items %}
                <div class="col">
                    {% include 'marketplace/_listing_card.html.twig' with {item: item, marketplaceReturnUrl: marketplaceReturnUrl} only %}
                </div>
            {% endfor %}
        </div>

        {# Load more #}
        {% if this.hasMoreItems %}
            <div class="text-center mt-4">
                <button
                    class="btn btn-outline-primary"
                    data-action="live#action"
                    data-live-action-param="loadMore"
                >
                    {{ 'marketplace.load_more'|trans }}
                    <span class="spinner-border spinner-border-sm ms-1 d-none" role="status" data-loading="removeClass(d-none)"></span>
                </button>
            </div>
        {% endif %}
    {% endif %}
</div>
