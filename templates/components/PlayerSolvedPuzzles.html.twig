<div {{ attributes }}>
    {# Filters and Sorting Section #}
    <div class="d-flex justify-content-end align-items-center mb-3 flex-wrap gap-2">
        {# Loading spinner - shown during component updates #}
        <div class="text-primary" style="display: none;" data-loading="show">
            <span class="spinner-border spinner-border-sm" role="status"></span>
        </div>

        {# Filter dropdown - available to everyone #}
        {% set isMember = logged_user.profile is not null and logged_user.profile.activeMembership %}
        <div class="dropdown">
            <button
                class="btn btn-outline-primary btn-sm dropdown-toggle"
                type="button"
                id="filtersDropdown"
                data-bs-toggle="dropdown"
                data-bs-auto-close="outside"
                aria-expanded="false"
            >
                <i class="bi-filter"></i>
                {{ 'filters.button'|trans }}
                {% if this.activeFiltersCount > 0 %}<sup>{{ this.activeFiltersCount }}</sup>{% endif %}
            </button>

            <div class="dropdown-menu dropdown-menu-start filters px-3 py-2" aria-labelledby="filtersDropdown" style="min-width: 320px;">
                {# FREE FILTERS - available to everyone #}

                {# Manufacturer filter with counts #}
                <div class="mb-3">
                    <select data-model="manufacturer" class="form-select form-select-sm">
                        <option value="">{{ 'filters.all_manufacturers'|trans }}</option>
                        {% for manufacturerName, count in this.availableManufacturers %}
                            <option value="{{ manufacturerName }}" {{ this.manufacturer == manufacturerName ? 'selected' }}>
                                {{ manufacturerName }} ({{ count }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {# Pieces count range filter #}
                <div class="mb-3">
                    <select data-model="piecesCountRange" class="form-select form-select-sm">
                        <option value="">{{ 'filters.all_pieces'|trans }}</option>
                        {% for range in this.availablePiecesRanges %}
                            <option value="{{ range.value }}" {{ this.piecesCountRange == range.value ? 'selected' }}>
                                {{ range.label }} {{ 'pieces'|trans }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {# Text search #}
                <div class="mb-3">
                    <input
                        type="text"
                        data-model="debounce(300)|searchQuery"
                        class="form-control form-control-sm"
                        value="{{ this.searchQuery }}"
                        placeholder="{{ 'filters.text_search_placeholder'|trans }}"
                    >
                </div>

                {# MEMBERS EXCLUSIVE FILTERS #}
                <div class="position-relative">
                    {# Overlay for non-members #}
                    {% if not isMember %}
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="z-index: 10; backdrop-filter: blur(2px); background: rgba(255,255,255,0.4);">
                            <button
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#membersExclusiveModal"
                                data-bs-dismiss="modal"
                            >
                                <i class="ci-locked me-1"></i>{{ 'membership.members_exclusive_button'|trans }}
                            </button>
                        </div>
                    {% endif %}

                    {# Relax puzzle filter #}
                    <div class="form-check form-switch mb-3">
                        <input
                            data-model="onlyRelax"
                            type="checkbox"
                            class="form-check-input"
                            role="switch"
                            id="only-relax"
                            {{ this.onlyRelax ? 'checked' }}
                            {{ not isMember ? 'disabled' }}>
                        <label for="only-relax" class="form-check-label" onclick="arguments[0].stopPropagation()">
                            <i class="bi bi-cup-hot"></i> {{ 'filters.only_relax'|trans }}
                        </label>
                    </div>

                    {# First tries filter #}
                    <div class="form-check form-switch mb-3">
                        <input
                            data-model="onlyFirstTries"
                            type="checkbox"
                            class="form-check-input"
                            role="switch"
                            id="only-first-attempt"
                            {{ this.onlyFirstTries ? 'checked' }}
                            {{ not isMember ? 'disabled' }}>
                        <label for="only-first-attempt" class="form-check-label" onclick="arguments[0].stopPropagation()">
                            {{ 'only_first_tries_filter'|trans }}
                        </label>
                    </div>

                    {# Unboxed filter #}
                    <div class="form-check form-switch mb-3">
                        <input
                            data-model="onlyUnboxed"
                            type="checkbox"
                            class="form-check-input"
                            role="switch"
                            id="only-unboxed"
                            {{ this.onlyUnboxed ? 'checked' }}
                            {{ not isMember ? 'disabled' }}>
                        <label for="only-unboxed" class="form-check-label" onclick="arguments[0].stopPropagation()">
                            <i class="bi bi-box-seam"></i> {{ 'only_unboxed_filter'|trans }}
                        </label>
                    </div>

                    {# Date range filter #}
                    <div class="mb-3" data-controller="datepicker">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                    <input
                                        type="text"
                                        data-model="dateFrom"
                                        class="form-control form-control-sm date-picker"
                                        value="{{ this.dateFrom }}"
                                        placeholder="{{ 'filters.date_from'|trans }}"
                                        data-datepicker-options='{"dateFormat": "d.m.Y", "maxDate": "today"}'
                                        {{ not isMember ? 'disabled' }}
                                    >
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                    <input
                                        type="text"
                                        data-model="dateTo"
                                        class="form-control form-control-sm date-picker"
                                        value="{{ this.dateTo }}"
                                        placeholder="{{ 'filters.date_to'|trans }}"
                                        data-datepicker-options='{"dateFormat": "d.m.Y", "maxDate": "today"}'
                                        {{ not isMember ? 'disabled' }}
                                    >
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Time/PPM filter #}
                    <div class="mb-3">
                        <div class="input-group input-group-sm">
                            <select data-model="speedComparison" class="form-select form-select-sm" {{ not isMember ? 'disabled' }}>
                                <option value="faster" {{ this.speedComparison == 'faster' ? 'selected' }}>
                                    {{ 'filters.faster_than'|trans }}
                                </option>
                                <option value="slower" {{ this.speedComparison == 'slower' ? 'selected' }}>
                                    {{ 'filters.slower_than'|trans }}
                                </option>
                            </select>
                            <input
                                type="number"
                                data-model="debounce(300)|speedValue"
                                class="form-control form-control-sm"
                                value="{{ this.speedValue }}"
                                min="0.1"
                                step="0.1"
                                {{ not isMember ? 'disabled' }}
                            >
                            <select data-model="speedUnit" class="form-select form-select-sm" {{ not isMember ? 'disabled' }}>
                                <option value="ppm" {{ this.speedUnit == 'ppm' ? 'selected' }}>PPM</option>
                                <option value="min" {{ this.speedUnit == 'min' ? 'selected' }}>min</option>
                            </select>
                        </div>
                    </div>
                </div>

                {# Reset filters button #}
                {% if this.activeFiltersCount > 0 %}
                    <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary w-100"
                        data-action="live#action"
                        data-live-action-param="resetFilters"
                    >
                        <i class="bi-x-circle"></i> {{ 'filters.reset'|trans }}
                    </button>
                {% endif %}
            </div>
        </div>

        {# Sorting dropdown #}
        <div class="dropdown">
            <button
                class="btn btn-outline-primary btn-sm dropdown-toggle"
                type="button"
                id="sortingDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
            >
                <i class="bi-sort-up"></i>
                {{ 'sorting.sort_by'|trans }}:
                {% if this.sortBy == 'fastest' %}{{ 'sorting.fastest_times'|trans }}{% endif %}
                {% if this.sortBy == 'slowest' %}{{ 'sorting.slowest_times'|trans }}{% endif %}
                {% if this.sortBy == 'newest' %}{{ 'sorting.newest_times'|trans }}{% endif %}
                {% if this.sortBy == 'oldest' %}{{ 'sorting.oldest_times'|trans }}{% endif %}
                {% if this.sortBy == 'fastest_ppm' %}{{ 'sorting.fastest_ppm'|trans }}{% endif %}
                {% if this.sortBy == 'slowest_ppm' %}{{ 'sorting.slowest_ppm'|trans }}{% endif %}
            </button>

            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="sortingDropdown">
                <button type="button" class="dropdown-item {% if this.sortBy == 'fastest' %}active{% endif %}"
                        data-action="live#action"
                        data-live-action-param="changeSortBy"
                        data-live-sort-param="fastest">
                    {{ 'sorting.fastest_times'|trans }}
                </button>
                <button type="button" class="dropdown-item {% if this.sortBy == 'slowest' %}active{% endif %}"
                        data-action="live#action"
                        data-live-action-param="changeSortBy"
                        data-live-sort-param="slowest">
                    {{ 'sorting.slowest_times'|trans }}
                </button>
                <button type="button" class="dropdown-item {% if this.sortBy == 'newest' %}active{% endif %}"
                        data-action="live#action"
                        data-live-action-param="changeSortBy"
                        data-live-sort-param="newest">
                    {{ 'sorting.newest_times'|trans }}
                </button>
                <button type="button" class="dropdown-item {% if this.sortBy == 'oldest' %}active{% endif %}"
                        data-action="live#action"
                        data-live-action-param="changeSortBy"
                        data-live-sort-param="oldest">
                    {{ 'sorting.oldest_times'|trans }}
                </button>
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item {% if this.sortBy == 'fastest_ppm' %}active{% endif %}"
                        data-action="live#action"
                        data-live-action-param="changeSortBy"
                        data-live-sort-param="fastest_ppm">
                    {{ 'sorting.fastest_ppm'|trans }}
                </button>
                <button type="button" class="dropdown-item {% if this.sortBy == 'slowest_ppm' %}active{% endif %}"
                        data-action="live#action"
                        data-live-action-param="changeSortBy"
                        data-live-sort-param="slowest_ppm">
                    {{ 'sorting.slowest_ppm'|trans }}
                </button>
            </div>
        </div>
    </div>

    {# Category tabs #}
    <div class="puzzle-category-types my-3" role="tablist">
        <button
            class="btn {{ this.category == 'solo' ? 'active' : '' }} {{ this.soloSolvedPuzzles|length == 0 ? 'disabled' : '' }}"
            data-action="live#action"
            data-live-action-param="changeResultsCategory"
            data-live-category-param="solo"
            {% if this.soloSolvedPuzzles|length == 0 %}disabled{% endif %}
        >
            <span class="users-icons"><i class="ci-user"></i></span>
            {{ 'ladder.solo'|trans }} ({{ this.soloSolvedPuzzles|length }})
        </button>

        <button
            class="btn {{ this.category == 'duo' ? 'active' : '' }} {{ this.duoSolvedPuzzles|length == 0 ? 'disabled' : '' }}"
            data-action="live#action"
            data-live-action-param="changeResultsCategory"
            data-live-category-param="duo"
            {% if this.duoSolvedPuzzles|length == 0 %}disabled{% endif %}
        >
            <span class="users-icons duo"><i class="ci-user"></i><i class="ci-user"></i></span>
            {{ 'ladder.duo'|trans }} ({{ this.duoSolvedPuzzles|length }})
        </button>

        <button
            class="btn {{ this.category == 'group' ? 'active' : '' }} {{ this.teamSolvedPuzzles|length == 0 ? 'disabled' : '' }}"
            data-action="live#action"
            data-live-action-param="changeResultsCategory"
            data-live-category-param="group"
            {% if this.teamSolvedPuzzles|length == 0 %}disabled{% endif %}
        >
            <span class="users-icons team"><i class="ci-user"></i><i class="ci-user"></i><i class="ci-user"></i><i class="ci-user"></i></span>
            {{ 'ladder.team'|trans }} ({{ this.teamSolvedPuzzles|length }})
        </button>
    </div>

    {# Content based on selected category #}
    <div class="tab-content mt-3">
        {% if this.category == 'solo' %}
            {{ include('_player_solvings.html.twig', {solved_puzzles: this.soloSolvedPuzzles, category: 'solo'}) }}
        {% elseif this.category == 'duo' %}
            {{ include('_player_solvings.html.twig', {solved_puzzles: this.duoSolvedPuzzles, category: 'duo'}) }}
        {% else %}
            {{ include('_player_solvings.html.twig', {solved_puzzles: this.teamSolvedPuzzles, category: 'team'}) }}
        {% endif %}
    </div>
</div>
