{#
    Stream for lend-borrow actions from puzzle detail page, collection detail, unsolved page, solved page, or wishlist page.

    Parameters:
    - puzzle_id: The puzzle ID
    - puzzle_statuses: UserPuzzleStatuses
    - action: 'lent', 'returned', 'passed', 'borrowed'
    - message: Toast message
    - context: 'detail' (puzzle detail page), 'collection-detail' (collection page), 'unsolved-detail' (unsolved page), 'solved-detail' (solved page), or 'list' (wishlist page)

    For collection-detail context, additional parameters:
    - item: CollectionItemOverview - full item data for card replacement
    - logged_user: Current logged user
    - collection_id: Collection ID

    For unsolved-detail context (only for pass/return actions on borrowed puzzles):
    - The item is removed because after pass/return, user no longer has the borrowed puzzle

    For solved-detail context:
    - The item is always replaced because puzzles stay in solved list (based on solving time, not ownership)

    For list context (wishlist), additional parameters:
    - remaining_count: Number of remaining items in wishlist
#}

{{ include('_modal_close_stream.html.twig') }}

{% if context|default('detail') == 'list' %}
    {# Wishlist page: remove the item and update count #}
    {{ include('_library_item_stream.html.twig', {
        action: 'remove',
        page_context: 'wishlist',
        puzzle_id: puzzle_id,
    }) }}

    {# Update the count #}
    <turbo-stream action="update" target="wishlist-count">
        <template>{{ remaining_count }}</template>
    </turbo-stream>

    {# Show empty state if no items remaining #}
    {% if remaining_count == 0 %}
    <turbo-stream action="update" target="wishlist-list-container">
        <template>
            {{ include('wishlist/_empty_state.html.twig') }}
        </template>
    </turbo-stream>
    {% endif %}
{% elseif context|default('detail') == 'collection-detail' %}
    {# Collection detail page: replace the whole card #}
    {% set coll_id = collection_id|default('__system_collection__') %}
    {{ include('_library_item_stream.html.twig', {
        action: 'replace',
        page_context: 'collection',
        item: item,
        puzzle_statuses: puzzle_statuses,
        logged_user: logged_user,
        isOwnProfile: true,
        source_collection_id: coll_id,
        currentCollectionId: coll_id,
    }) }}
{% elseif context|default('detail') == 'unsolved-detail' %}
    {# Unsolved puzzles page #}
    {% if is_owner|default(false) and item is defined %}
        {# Owner's puzzle: replace card with updated badges (lent/returned/borrowed) #}
        {{ include('_library_item_stream.html.twig', {
            action: 'replace',
            page_context: 'unsolved',
            item: item,
            puzzle_statuses: puzzle_statuses,
            logged_user: logged_user,
            isOwnProfile: true,
        }) }}
    {% else %}
        {# Borrower returned/passed: remove card (user no longer has puzzle) #}
        {{ include('_library_item_stream.html.twig', {
            action: 'remove',
            page_context: 'unsolved',
            puzzle_id: puzzle_id,
        }) }}

        {# Update the unsolved count #}
        {% if remaining_count is defined %}
        <turbo-stream action="update" target="unsolved-count">
            <template>{{ remaining_count }}</template>
        </turbo-stream>
        {% endif %}
    {% endif %}
{% elseif context|default('detail') == 'solved-detail' %}
    {# Solved puzzles page: always replace card (puzzles stay based on solving time) #}
    {% if item is defined %}
        {{ include('_library_item_stream.html.twig', {
            action: 'replace',
            page_context: 'solved',
            item: item,
            puzzle_statuses: puzzle_statuses,
            logged_user: logged_user,
            isOwnProfile: true,
        }) }}
    {% endif %}
{% else %}
    {# Puzzle detail page: update badges and dropdown #}
    <turbo-stream action="update" target="puzzle-badges-{{ puzzle_id }}">
        <template>
            {{ include('puzzle/_badges.html.twig', {
                puzzle_id: puzzle_id,
                puzzle_statuses: puzzle_statuses
            }) }}
        </template>
    </turbo-stream>

    {{ include('puzzle/_dropdown_actions_stream.html.twig', {
        puzzle_id: puzzle_id,
        puzzle_statuses: puzzle_statuses,
    }) }}
{% endif %}

{{ include('_toast_stream.html.twig', {message: message}) }}
