{#
    Grouped wrapper for all puzzle dropdown actions.
    Replaced as a whole via turbo stream to ensure all dropdowns update together.

    Required variables: puzzle_id, puzzle_statuses
    Optional variables: source_collection_id, context, currentCollectionId, tab
#}
{% set context = context|default('detail') %}
<div id="puzzle-dropdown-actions-{{ puzzle_id }}" style="display: contents;">
{# Handle both cases: logged_user with .profile attribute (from Twig global) or raw User object (from stream response) #}
{% set hasProfile = logged_user.profile is defined and logged_user.profile is not null %}
{% if hasProfile %}
    {{ include('wishlist/_dropdown_action.html.twig', {
        puzzle_id: puzzle_id,
        puzzle_statuses: puzzle_statuses,
        context: context,
    }) }}

    {{ include('collections/_dropdown_action.html.twig', {
        puzzle_id: puzzle_id,
        puzzle_statuses: puzzle_statuses,
        source_collection_id: source_collection_id|default(null),
        context: context,
        currentCollectionId: currentCollectionId|default(null),
    }) }}

    {{ include('sell-swap/_dropdown_action.html.twig', {
        puzzle_id: puzzle_id,
        puzzle_statuses: puzzle_statuses,
        context: context,
        currentCollectionId: currentCollectionId|default(null),
    }) }}

    {{ include('lend-borrow/_dropdown_action.html.twig', {
        puzzle_id: puzzle_id,
        puzzle_statuses: puzzle_statuses,
        logged_user: logged_user,
        context: context,
        tab: tab|default(null),
        currentCollectionId: currentCollectionId|default(null),
    }) }}
{% endif %}

{% set puzzle_offer_count = (offer_counts is defined and offer_counts[puzzle_id] is defined) ? offer_counts[puzzle_id] : null %}
<li><hr class="dropdown-divider"></li>

{% if puzzle_offer_count is not null and puzzle_offer_count > 0 %}
    <li>
        <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ path('puzzler_offers', {puzzleId: puzzle_id}) }}">
            <span><i class="bi bi-shop me-1"></i> {{ 'puzzler_offers.offers_link'|trans({'%count%': puzzle_offer_count}) }}</span>
            <span class="badge bg-primary ms-2">{{ 'new_badge'|trans }}</span>
        </a>
    </li>
{% elseif puzzle_offer_count is not null %}
    <li>
        <span class="dropdown-item disabled">
            <i class="bi bi-shop me-1"></i> {{ 'puzzler_offers.offers_link'|trans({'%count%': 0}) }}
        </span>
    </li>
{% endif %}

{# Visible to all users - redirects to login if not authenticated #}
{{ include('puzzle-report/_dropdown_action.html.twig', {
    puzzle_id: puzzle_id,
}) }}
</div>
