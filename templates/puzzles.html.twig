{% extends 'base.html.twig' %}

{% block title %}{{ 'puzzle_overview.meta.title'|trans }}{% endblock %}

{% block content %}
    <h1>{{ 'puzzle_overview.title'|trans }}</h1>

        <div data-controller="range-slider">
            <form action="{{ path('puzzles') }}" method="get"
                  data-controller="puzzle-search"
                  data-puzzle-search-target="form"
                  data-turbo-frame="search-results"
                  data-turbo="true"
                >
                <div class="row">
                    <div class="col-sm-6">
                        {{ form_row(search_form.brand) }}
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label">Pieces</label><br>

                        <div class="form-check form-option form-check-inline mb-2">
                            <input type="radio" class="form-check-input" id="pieces-any" name="{{ field_name(search_form.pieces) }}" value="">
                            <label for="pieces-any" class="form-option-label">Any</label>
                        </div>
                        <div class="form-check form-option form-check-inline mb-2">
                            <input type="radio" class="form-check-input" id="pieces-1-499" value="1-499" name="{{ field_name(search_form.pieces) }}">
                            <label for="pieces-1-499" class="form-option-label">1-499</label>
                        </div>
                        <div class="form-check form-option form-check-inline mb-2">
                            <input type="radio" class="form-check-input" id="pieces-500" value="500" name="{{ field_name(search_form.pieces) }}">
                            <label for="pieces-500" class="form-option-label">500</label>
                        </div>
                        <div class="form-check form-option form-check-inline mb-2">
                            <input type="radio" class="form-check-input" id="pieces-501-999" value="501-999" name="{{ field_name(search_form.pieces) }}">
                            <label for="pieces-501-999" class="form-option-label">501-999</label>
                        </div>
                        <div class="form-check form-option form-check-inline mb-2">
                            <input type="radio" class="form-check-input" id="pieces-1000" value="1000" name="{{ field_name(search_form.pieces) }}">
                            <label for="pieces-1000" class="form-option-label">1000</label>
                        </div>
                        <div class="form-check form-option form-check-inline mb-2">
                            <input type="radio" class="form-check-input" id="pieces-1001" value="1001+" name="{{ field_name(search_form.pieces) }}">
                            <label for="pieces-1001" class="form-option-label">1001+</label>
                        </div>
                    </div>
                </div>

                <div class="d-none">
                    {{ form_row(search_form.tags) }}
                </div>

                <div class="d-none">
                    {{ form_row(search_form.onlySolvedByMe) }}
                </div>

                <div class="my-3">
                    {{ form_row(search_form.onlyWithResults) }}
                </div>

                <div class="row">
                    <div class="col-sm-6">
                        <div class="input-group">
                            {{ form_widget(search_form.search, {'attr': {'class': 'form-control'}}) }}
                            <button class="btn btn-primary btn-icon" type="submit">
                                Search <i class="ci-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                {{ form_rest(search_form) }}
            </form>

            <turbo-frame id="search-results">
                <p class="mt-2">
                    <small class="text-muted">Total found: {{ total_puzzles_count }}</small>
                </p>

                <p class="mt-5 my-3 text-muted">{{ 'puzzle_overview.missing_puzzle_info'|trans }}</p>

                {% for puzzle in puzzles %}
                    <div
                        class="shadow-lg my-3 py-3 px-3"
                        data-puzzle-filter-target="puzzleItem"
                        data-pieces-count="{{ puzzle.piecesCount }}"
                        data-puzzle-name="{{ puzzle.puzzleName }}"
                        data-puzzle-code="{{ puzzle.puzzleIdentificationNumber }}"
                        data-puzzle-alternative-name="{{ puzzle.puzzleAlternativeName }}"
                        data-manufacturer="{{ puzzle.manufacturerName }}"
                        data-available="{{ puzzle.isAvailable ? 1 : 0 }}"
                        data-has-time="{{ puzzle.solvedTimes > 0 ? 1 : 0 }}"
                        data-tags="{{ (tags[puzzle.puzzleId] ?? [])|json_encode }}"
                    >
                        <div class="row">
                            <div class="col-md align-self-center">
                                <a href="{{ path('puzzle_detail', {puzzleId: puzzle.puzzleId}) }}">
                                    {{ include('_puzzle_name.html.twig', {
                                        puzzle_name: puzzle.puzzleName,
                                        alternative_puzzle_name: puzzle.puzzleAlternativeName,
                                    }) }}

                                    {% if puzzle.puzzleIdentificationNumber is not null %}
                                        <br><small class="text-muted">{{ puzzle.puzzleIdentificationNumber }}</small>
                                    {% endif %}
                                </a>
                            </div>

                            <div class="col-md text-md-center align-self-center">
                                {% if puzzle.puzzleImage is not null%}
                                    <a href="{{ path('puzzle_detail', {puzzleId: puzzle.puzzleId}) }}">
                                        <img class="rounded-2" style="max-width: 100px;max-height: 100px;" alt="{{ 'puzzle_img_alt'|trans({'%puzzle%': puzzle.manufacturerName ~ ' ' ~ puzzle.puzzleName}) }}" src="{{ puzzle.puzzleImage|imagine_filter('puzzle_small') }}">
                                    </a>
                                {% endif %}
                            </div>

                            <div class="col-md align-self-center text-md-center">
                                <b>{{ puzzle.manufacturerName|upper }}</b><br>
                                {{ 'pieces_count'|trans({ '%count%': puzzle.piecesCount })|raw }}
                            </div>

                            <div class="col-md align-self-center text-md-center">
                                {% for tag in tags[puzzle.puzzleId] ?? [] %}
                                    <span class="badge bg-primary rounded-pill"><i class="ci-diamond"></i> {{ tag.name }}</span>
                                {% endfor %}

                                {% if puzzle.puzzleId in puzzles_solved_by_user %}
                                    <span class="badge bg-success rounded-pill"><i class="ci-check"></i> {{ 'puzzle_solved'|trans }}</span>
                                {% endif %}

                                {% if app.request.locale is same as 'cs' %}
                                    {% if puzzle.isAvailable %}
                                        <span class="badge bg-success rounded-pill">{{ 'puzzle_available'|trans }}</span>
                                    {% else %}
                                        <span class="badge bg-dark rounded-pill">{{ 'puzzle_not_available'|trans }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>

                            <div class="col-md align-self-center">
                                {% if puzzle.solvedTimes > 0 %}
                                    <table class="table-times-overview">
                                        <tr>
                                            <td><small>{{ 'puzzle_solved_count'|trans }}</small></td>
                                            <td class="text-end"><small>{{ puzzle.solvedTimes }}</small></td>
                                        </tr>
                                        {% if ranking[puzzle.puzzleId] is defined %}
                                            <tr>
                                                <td><small>{{ 'my_time'|trans }}</small></td>
                                                <td class="text-end"><small>{{ ranking[puzzle.puzzleId].time|puzzlingTime }}</small></td>
                                            </tr>
                                        {% endif %}
                                        <tr>
                                            <td><small>{{ 'fastest_time'|trans }}</small></td>
                                            <td class="text-end"><small>{{ puzzle.fastestTimeSolo|puzzlingTime }}</small></td>
                                        </tr>
                                        <tr>
                                            <td><small>{{ 'average_time'|trans }}</small></td>
                                            <td class="text-end"><small>{{ puzzle.averageTimeSolo|puzzlingTime }}</small></td>
                                        </tr>
                                    </table>
                                {% else %}
                                    <small>{{ 'never_solved_puzzles'|trans }}</small>
                                {% endif %}
                            </div>

                            <div class="col-md align-self-center text-md-center">
                                {% if puzzle.solvedTimes > 0 %}
                                    <a href="{{ path('puzzle_detail', {puzzleId: puzzle.puzzleId}) }}" class="btn py-1 px-2 my-1 btn-sm btn-primary">{{ 'show_times'|trans }}</a>
                                {% endif %}
                                <a href="{{ path('add_time', {puzzleId: puzzle.puzzleId}) }}" class="btn py-1  px-2 my-1 btn-accent btn-sm"><i class="ci-add"></i> {{ 'add_my_time'|trans }}</a>
                                <a href="{{ path('stopwatch_puzzle', {puzzleId: puzzle.puzzleId}) }}" class="btn btn-accent btn-sm py-1 px-2 my-1"><i class="ci-time"></i> {{ 'start_solving'|trans }}</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                {% if next_offset < total_puzzles_count %}
                    {% set loadMoreParameters = app.request.query.all|merge({'offset': next_offset}) %}

                    <p class="text-center mt-3">
                        <a href="{{ url(app.request.attributes.get('_route'), loadMoreParameters) }}" class="btn btn-primary">Load more...</a>
                        <br>
                        <small class="text-muted">Remaining: {{ total_puzzles_count - current_offset }}</small>
                        <br>
                        <a class="small" href="#top">back to top</a>
                    </p>

                {% endif %}

                {% if total_puzzles_count == 0 %}
                    <div class="alert alert-warning">
                        {{ 'filters.no_puzzle_matches_filters'|trans }}
                    </div>
                {% endif %}
            </div>
        </turbo-frame>
{% endblock %}
