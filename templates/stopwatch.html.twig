{% extends 'base.html.twig' %}

{% block title %}{{ 'stopwatch.meta.title'|trans }}{% endblock %}

{% block content %}
    <div
        class="stopwatch-page"
        data-controller="stopwatch"
        data-stopwatch-status-value="{{ active_stopwatch is not null ? active_stopwatch.status.value : '' }}"
        data-stopwatch-stopwatch-id-value="{{ active_stopwatch is not null ? active_stopwatch.stopwatchId : '' }}"
        data-stopwatch-total-seconds-value="{{ active_stopwatch is not null ? active_stopwatch.totalSeconds : 0 }}"
        data-stopwatch-last-start-value="{{ active_stopwatch is not null ? active_stopwatch.lastStart|date('c') : '' }}"
        data-stopwatch-server-now-value="{{ 'now'|date('c') }}"
        data-stopwatch-start-url-value="{{ path('api_stopwatch_start') }}"
        data-stopwatch-puzzle-id-value="{{ active_puzzle is not null ? active_puzzle.puzzleId : '' }}"
        data-stopwatch-finish-url-template-value="{{ path('finish_stopwatch', {stopwatchId: '__STOPWATCH_ID__'}) }}"
        data-stopwatch-reset-url-value="{{ active_puzzle is not null ? path('stopwatch_puzzle', {puzzleId: active_puzzle.puzzleId}) : path('stopwatch') }}"
        data-stopwatch-milestones-value="{{ milestones|map(m => {label: m.label, timeSeconds: m.timeSeconds, type: m.type, avatar: m.avatar is not null ? m.avatar|thumbnail('puzzle_small') : null, rank: m.rank})|json_encode|e('html_attr') }}"
        data-stopwatch-solo-times-value="{{ solo_times|json_encode|e('html_attr') }}"
        data-stopwatch-label-solved-times-value="{{ (solo_times|length == 1 ? 'stopwatch.solved_time' : 'stopwatch.solved_times')|trans({'%count%': solo_times|length}) }}"
        data-stopwatch-label-current-ranking-value="{{ 'stopwatch.current_ranking'|trans({'%rank%': '%rank%', '%total%': '%total%'}) }}"
        data-stopwatch-label-delete-confirm-value="{{ 'stopwatch.delete_confirm'|trans }}"
    >
        {# Toolbar row #}
        <div class="stopwatch-toolbar d-flex align-items-center justify-content-between px-3 py-2">
            <div class="form-check form-switch mb-0" data-stopwatch-target="wakeLockToggle">
                <input class="form-check-input" type="checkbox" id="stopwatch-wake-lock" data-stopwatch-target="wakeLockCheckbox" data-action="stopwatch#toggleWakeLock">
                <label class="form-check-label small" for="stopwatch-wake-lock">{{ 'stopwatch.display_always_on'|trans }}</label>
            </div>

            <div class="stopwatch-name-area text-end">
                {% if active_stopwatch is not null %}
                    <span class="stopwatch-name-display" data-stopwatch-target="nameDisplay" data-action="click->stopwatch#editName" role="button">{{ active_stopwatch.name ?? '' }}</span>
                    <input type="text"
                        class="form-control form-control-sm d-none stopwatch-name-input"
                        data-stopwatch-target="nameInput"
                        data-action="blur->stopwatch#saveName keydown->stopwatch#saveNameOnEnter"
                        value="{{ active_stopwatch.name ?? '' }}"
                        placeholder="{{ 'stopwatch.meta.title'|trans }}"
                        maxlength="100"
                    >
                    <button type="button" class="btn btn-sm btn-link p-0 ms-1" data-action="stopwatch#editName" title="Rename">
                        <i class="ci-edit"></i>
                    </button>
                {% endif %}
            </div>
        </div>

        {# Puzzle banner #}
        {% if active_puzzle is not null %}
            <a href="{{ path('puzzle_detail', {puzzleId: active_puzzle.puzzleId, return: app.request.uri, return_title: 'stopwatch.meta.title'|trans}) }}" class="stopwatch-puzzle-banner d-flex align-items-center gap-3 px-3 py-2 text-decoration-none text-body">
                {% if active_puzzle.puzzleImage is not null %}
                    <img class="rounded-2 stopwatch-puzzle-thumb"
                         alt="{{ 'puzzle_img_alt'|trans({'%puzzle%': active_puzzle.manufacturerName ~ ' ' ~ active_puzzle.puzzleName}) }}"
                         src="{{ active_puzzle.puzzleImage|thumbnail('puzzle_small') }}"
                    >
                {% endif %}
                <div>
                    <strong>{{ active_puzzle.puzzleName }}</strong><br>
                    <small class="text-muted">{{ active_puzzle.manufacturerName|upper }} &middot; {{ 'pieces_count'|trans({ '%count%': active_puzzle.piecesCount })|raw }}</small>
                </div>
            </a>
        {% endif %}

        {# Card wraps timer + buttons #}
        <div class="card shadow mt-2">
            <div class="card-body text-center">
                {# Timer display #}
                <div class="stopwatch-timer-wrap py-3">
                    <div class="stopwatch-digits">
                        <span class="stopwatch-digit" data-stopwatch-target="hours">{% if active_stopwatch is not null %}{{ active_stopwatch.interval|hoursElapsed }}{% else %}00{% endif %}</span><span class="stopwatch-separator">:</span><span class="stopwatch-digit" data-stopwatch-target="minutes">{% if active_stopwatch is not null %}{{ active_stopwatch.interval|minutesElapsed }}{% else %}00{% endif %}</span><span class="stopwatch-separator">:</span><span class="stopwatch-digit" data-stopwatch-target="seconds">{% if active_stopwatch is not null %}{{ active_stopwatch.interval|secondsElapsed }}{% else %}00{% endif %}</span>
                    </div>
                </div>

                {# Action buttons - fixed height to prevent layout shift #}
                <div class="stopwatch-actions pb-2">
                    <button type="button"
                        class="btn btn-success btn-lg {{ active_stopwatch is not null ? 'd-none' : '' }}"
                        data-stopwatch-target="startBtn"
                        data-action="stopwatch#start"
                    >
                        <i class="ci-play me-1"></i> {{ 'stopwatch.start'|trans }}
                    </button>

                    <button type="button"
                        class="btn btn-danger btn-lg {{ active_stopwatch is null or active_stopwatch.status.value != 'running' ? 'd-none' : '' }}"
                        data-stopwatch-target="pauseBtn"
                        data-action="stopwatch#pause"
                    >
                        <i class="ci-time me-1"></i> {{ 'stopwatch.stop'|trans }}
                    </button>

                    <button type="button"
                        class="btn btn-accent btn-lg {{ active_stopwatch is null or active_stopwatch.status.value != 'paused' ? 'd-none' : '' }}"
                        data-stopwatch-target="resumeBtn"
                        data-action="stopwatch#resume"
                    >
                        <i class="ci-play me-1"></i> {{ 'stopwatch.continue'|trans }}
                    </button>

                    <div class="d-flex justify-content-center gap-2 mt-3 {{ active_stopwatch is null or active_stopwatch.status.value != 'paused' ? 'd-none' : '' }}" data-stopwatch-target="finishBtn">
                        <a href="{{ active_stopwatch is not null ? path('finish_stopwatch', {stopwatchId: active_stopwatch.stopwatchId}) : '#' }}" class="btn btn-outline-success btn-sm" data-stopwatch-target="finishLink" data-turbo-prefetch="false">
                            <i class="ci-check me-1"></i> {{ 'stopwatch.finish'|trans }}
                        </a>
                        <button type="button"
                            class="btn btn-outline-danger btn-sm"
                            data-action="stopwatch#reset"
                        >
                            <i class="ci-reload me-1"></i> {{ 'stopwatch.reset'|trans }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if logged_user.profile.activeMembership %}
            {# Live rank #}
            {% if solo_times|length > 0 %}
                <div class="text-center mt-3" style="min-height: 1.5rem;">
                    <span class="badge bg-secondary stopwatch-rank" data-stopwatch-target="rankDisplay">{{ (solo_times|length == 1 ? 'stopwatch.solved_time' : 'stopwatch.solved_times')|trans({'%count%': solo_times|length}) }}</span>
                </div>
            {% endif %}

            {# Milestone bar #}
            {% if milestones|length > 0 %}
                <div class="stopwatch-milestones mx-auto mt-3 d-none" data-stopwatch-target="milestoneBar">
                    <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                        <span class="stopwatch-milestone-avatar d-none" data-stopwatch-target="milestoneAvatar"></span>
                        <span class="fw-medium" data-stopwatch-target="milestoneLabel"></span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" role="progressbar" data-stopwatch-target="milestoneProgress" style="width: 0%;"></div>
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="stopwatch-timeline-placeholder card-body card mt-3 shadow-custom">
                <button
                    class="btn btn-outline-secondary bg-white btn-sm px-3 fs-sm mt-2 shadow-custom"
                    data-bs-toggle="modal"
                    data-bs-target="#membersExclusiveModal"
                >
                    <i class="ci-locked me-1"></i>
                    {{ 'membership.members_exclusive_button'|trans }}
                </button>
            </div>
        {% endif %}

        {# Other stopwatches #}
        {% if stopwatches|length > 1 or (stopwatches|length is same as 1 and active_stopwatch is null) %}
            <div class="mt-5" data-stopwatch-target="otherStopwatches">
                <h5 class="mb-3">{{ 'stopwatch.more_my_stopwatches'|trans }}</h5>
                <div class="card shadow-sm">
                    <div class="list-group list-group-flush">
                        {% set row_index = 0 %}
                        {% for stopwatch in stopwatches %}
                            {% if active_stopwatch is null or stopwatch.stopwatchId is not same as active_stopwatch.stopwatchId %}
                                <div class="list-group-item d-flex align-items-center gap-3 py-3 {{ row_index is odd ? 'stopwatch-other-row-odd' : '' }}">
                                    <a href="{{ path('stopwatch', {stopwatchId: stopwatch.stopwatchId}) }}" class="d-flex align-items-center gap-3 flex-grow-1 text-decoration-none text-body min-width-0">
                                        <div>
                                            <span class="stopwatch-other-time">{{ stopwatch.interval|puzzlingTime }}</span>
                                            <div class="text-muted small">{{ stopwatch.lastStart|ago }}</div>
                                        </div>
                                        <span class="flex-grow-1 text-truncate">
                                            {% if stopwatch.name is not null %}{{ stopwatch.name }}{% elseif stopwatch.puzzleId is not null %}{{ stopwatch.puzzleName }}{% endif %}
                                        </span>
                                        <span class="badge bg-{{ stopwatch.status.value == 'running' ? 'success' : 'secondary' }}">{{ ('stopwatch.status.' ~ stopwatch.status.value)|trans }}</span>
                                    </a>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-danger flex-shrink-0"
                                        data-action="stopwatch#deleteOther"
                                        data-stopwatch-stopwatch-id-param="{{ stopwatch.stopwatchId }}"
                                        title="{{ 'stopwatch.reset'|trans }}"
                                    >
                                        <i class="ci-trash"></i>
                                    </button>
                                </div>
                                {% set row_index = row_index + 1 %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
